---
const {
  prefix,
  articleId,
  tocId,
  title = "目录",
  ariaLabel,
} = Astro.props;

const tocClass = `${prefix}__toc`;
const titleClass = `${prefix}__toc-title`;
const listClass = `${prefix}__toc-list`;
const itemClass = `${prefix}__toc-item`;
const subClass = `${prefix}__toc-sub`;
---

<aside class={tocClass}>
  <div class={titleClass}>{title}</div>
  <nav id={tocId} class={listClass} aria-label={ariaLabel}></nav>
</aside>

<script define:vars={{ articleId, tocId, itemClass, subClass }}>
  const article = document.getElementById(articleId);
  const toc = document.getElementById(tocId);
  if (article && toc) {
    const headings = Array.from(article.querySelectorAll("h2, h3"));
    const slugify = (s) =>
      s
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\u4e00-\u9fa5]+/g, "-")
        .replace(/^-+|-+$/g, "");
    const items = [];
    headings.forEach((h) => {
      const text = h.textContent || "";
      const id = h.id || slugify(text);
      if (!h.id) h.id = id;
      items.push({ id, depth: h.tagName === "H2" ? 2 : 3, text });
    });
    const html = items
      .map(
        (i) =>
          `<a href="#${i.id}" class="${itemClass} ${i.depth === 3 ? subClass : ""}" data-id="${i.id}">${i.text}</a>`
      )
      .join("");
    toc.innerHTML = html;
    const links = Array.from(toc.querySelectorAll(`.${itemClass}`));
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.id;
          const link = toc.querySelector(`.${itemClass}[data-id="${id}"]`);
          if (link && entry.isIntersecting) {
            links.forEach((l) => {
              l.classList.remove("active");
              l.removeAttribute("aria-current");
            });
            link.classList.add("active");
            link.setAttribute("aria-current", "true");
          }
        });
      },
      { rootMargin: "0px 0px -60% 0px", threshold: 0.1 }
    );
    headings.forEach((h) => observer.observe(h));
  }
</script>
