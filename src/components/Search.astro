---
// src/components/Search.astro
---

<dialog
    id="search-dialog"
    role="dialog"
    aria-modal="true"
    aria-label="Site Search"
    class="fixed inset-0 z-[100] w-full h-full max-w-none max-h-none bg-black/20 backdrop-blur-[2px] p-0 flex items-start justify-center opacity-0 pointer-events-none transition-opacity duration-300 open:opacity-100 open:pointer-events-auto m-0"
>
    <div
        class="relative mt-6 w-[min(90vw,600px)] bg-surface border border-black/10 shadow-lg overflow-hidden origin-top flex flex-col"
        id="search-panel"
        style="border-radius: 20px; height: 56px; transition: border-radius 0.1s cubic-bezier(0.23, 1, 0.32, 1), height 0.5s cubic-bezier(0.23, 1, 0.32, 1);"
    >
        <!-- Search Input -->
        <div class="relative h-14 flex items-center">
            <div
                class="absolute left-6 flex items-center pointer-events-none text-secondary"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><circle cx="11" cy="11" r="8"></circle><path
                        d="m21 21-4.3-4.3"></path></svg
                >
            </div>
            <input
                type="text"
                id="search-input"
                class="w-full h-full bg-transparent text-primary text-lg pl-16 pr-16 focus:outline-none placeholder:text-secondary/60 font-mono opacity-0 transition-opacity duration-300 delay-100"
                placeholder="Search..."
                autocomplete="off"
                aria-controls="search-results"
            />
            <div class="absolute right-4 flex items-center">
                <kbd
                    class="hidden md:inline-flex items-center gap-1 px-2 py-1 text-xs font-mono text-secondary bg-black/5 rounded border border-black/10 opacity-0 transition-opacity duration-300 delay-100"
                    id="esc-hint"
                >
                    <span class="text-xs">ESC</span>
                </kbd>
            </div>
        </div>

        <!-- Results -->
        <div
            class="opacity-0 transition-opacity duration-300 delay-150 border-t border-black/10 flex-1 flex flex-col min-h-0"
            id="search-content"
        >
            <div class="flex-1 overflow-y-auto p-2 min-h-0" id="search-results">
                <div class="p-8 text-center text-secondary font-mono text-sm">
                    Start typing to search.
                </div>
            </div>

            <!-- Footer -->
            <div
                class="px-4 py-2 bg-black/5 border-t border-black/10 flex justify-between items-center text-[10px] text-secondary uppercase"
            >
                <span>Fuse.js</span>
                <span>Index ready</span>
            </div>
        </div>
    </div>
</dialog>

<script>
    import Fuse from "fuse.js";

    let fuse: Fuse<any> | null = null;
    const dialog = document.getElementById(
        "search-dialog",
    ) as HTMLDialogElement;
    const input = document.getElementById("search-input") as HTMLInputElement;
    const resultsContainer = document.getElementById("search-results");
    const panel = document.getElementById("search-panel");
    const content = document.getElementById("search-content");
    const inputEl = document.getElementById("search-input");
    const escHint = document.getElementById("esc-hint");
    const header = document.getElementById("main-header");

    // Fetch index
    async function loadIndex() {
        if (fuse) return;
        try {
            const res = await fetch("/search-index.json");
            const data = await res.json();
            fuse = new Fuse(data, {
                keys: ["title", "description", "tags"],
                threshold: 0.4,
                includeMatches: true,
            });
        } catch (e) {
            console.error("Failed to load search index", e);
        }
    }

    // Open/Close logic
    function openSearch() {
        loadIndex();

        // Calculate scrollbar width before hiding it
        const scrollbarWidth =
            window.innerWidth - document.documentElement.clientWidth;

        dialog?.showModal();

        // Hide Header
        if (header) header.style.opacity = "0";
        if (header) header.style.pointerEvents = "none";

        // Show Dialog
        dialog?.classList.remove("opacity-0", "pointer-events-none");

        // First RAF: Ensure initial state is rendered
        requestAnimationFrame(() => {
            // Second RAF: Actually trigger the animation
            requestAnimationFrame(() => {
                if (panel) {
                    panel.style.borderRadius = "16px";
                    panel.style.height = "400px"; // Fixed height instead of auto
                }
                // Fade in contents with slight delay
                setTimeout(() => {
                    if (content) content.style.opacity = "1";
                    if (inputEl) inputEl.style.opacity = "1";
                    if (escHint) escHint.style.opacity = "1";
                }, 100);
            });
        });

        setTimeout(() => input?.focus(), 200);

        // Hide scroll and compensate for scrollbar width
        document.body.style.overflow = "hidden";
        document.body.style.paddingRight = `${scrollbarWidth}px`;
    }

    function closeSearch() {
        // Fade out contents first
        if (content) content.style.opacity = "0";
        if (inputEl) inputEl.style.opacity = "0";
        if (escHint) escHint.style.opacity = "0";

        // Wait a bit, then shrink panel
        setTimeout(() => {
            if (panel) {
                panel.style.borderRadius = "20px";
                panel.style.height = "56px";
            }
        }, 100);

        // Show Header after panel starts shrinking
        setTimeout(() => {
            if (header) {
                header.style.opacity = "1";
                header.style.pointerEvents = "auto";
            }
        }, 200);

        // Fade out dialog background
        setTimeout(() => {
            dialog?.classList.add("opacity-0", "pointer-events-none");
        }, 300);

        setTimeout(() => {
            dialog?.close();
            document.body.style.overflow = "";
            document.body.style.paddingRight = ""; // Reset padding
            if (input) input.value = "";
            if (resultsContainer)
                resultsContainer.innerHTML =
                    '<div class="h-full flex items-center justify-center text-secondary font-mono text-sm">Start typing to search.</div>';
        }, 600); // Wait for all animations to complete
    }

    // Event Listeners
    window.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
            e.preventDefault();
            if (dialog?.open) closeSearch();
            else openSearch();
        }
        if (e.key === "Escape" && dialog?.open) {
            closeSearch();
        }
    });

    dialog?.addEventListener("click", (e) => {
        if (e.target === dialog) closeSearch();
    });
    dialog?.addEventListener("keydown", (e) => {
        if (e.key !== "Tab") return;
        const focusable = dialog.querySelectorAll(
            "a[href], button, input, select, textarea, [tabindex]:not([tabindex='-1'])"
        );
        const elements = Array.from(focusable) as HTMLElement[];
        if (elements.length === 0) return;
        const first = elements[0];
        const last = elements[elements.length - 1];
        const active = document.activeElement as HTMLElement | null;
        if (e.shiftKey) {
            if (active === first || active === dialog) {
                e.preventDefault();
                last.focus();
            }
        } else {
            if (active === last) {
                e.preventDefault();
                first.focus();
            }
        }
    });

    // Expose open function globally for the header button
    (window as any).openSearch = openSearch;

    // Search Logic
    input?.addEventListener("input", (e) => {
        if (!fuse || !resultsContainer) return;
        const query = (e.target as HTMLInputElement).value;

        if (!query) {
            resultsContainer.innerHTML =
                '<div class="p-8 text-center text-secondary font-mono text-sm">Start typing to search.</div>';
            return;
        }

        const results = fuse.search(query);

        if (results.length === 0) {
            resultsContainer.innerHTML =
                '<div class="p-8 text-center text-secondary font-mono text-sm">No results found.</div>';
            return;
        }

        const html = results
            .map((result) => {
                const item = result.item;
                return `
        <a href="${item.slug}" class="block p-3 rounded-lg hover:bg-black/5 group transition-colors border border-transparent hover:border-black/10">
          <div class="flex items-center justify-between mb-1">
            <h4 class="text-primary font-semibold group-hover:text-accent-cyan transition-colors">${item.title}</h4>
            <span class="text-[10px] uppercase text-secondary/60 bg-black/5 px-1.5 py-0.5 rounded">${item.collection}</span>
          </div>
          <p class="text-sm text-secondary line-clamp-1 font-mono">${item.description}</p>
        </a>
      `;
            })
            .join("");

        resultsContainer.innerHTML = html;
    });
</script>
