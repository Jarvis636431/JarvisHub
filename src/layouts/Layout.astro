---
import { SEO } from "astro-seo";
import "../styles/global.css";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { languages } from "../i18n/ui";

type NavLink = { href: string; label: string };
type StructuredData = Record<string, unknown> | Record<string, unknown>[];

type TwitterConfig = {
  card?: "summary" | "summary_large_image" | "player" | "app";
  site?: string;
  creator?: string;
  image?: string;
  imageAlt?: string;
  title?: string;
  description?: string;
};

interface SeoConfig {
  canonical?: string;
  type?: string;
  image?: {
    src: string;
    alt?: string;
  };
  noindex?: boolean;
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  twitter?: TwitterConfig;
  structuredData?: StructuredData;
}

interface LayoutProps {
  title?: string;
  description?: string;
  navLinks?: NavLink[];
  footerNote?: string;
  seo?: SeoConfig;
  lang?: "en" | "zh";
}

const fallbackSite = "https://jarvishub.com";

const {
  title = "Jarvis Hub - Creative Developer",
  description = "Personal website of Jarvis Hub - crafting web experiences, writing, and sharing experiments in code.",
  footerNote = "Built with Astro - Designed by Jarvis",
  seo,
  lang = "en",
} = Astro.props as LayoutProps;

const t = useTranslations(lang);

const navLinks = [
  {
    href: lang === "en" ? "/projects" : "/zh/projects",
    label: t("nav.projects"),
  },
  { href: lang === "en" ? "/blog" : "/zh/blog", label: t("nav.blog") },
];

const requestUrl = Astro.url;
const siteOrigin = Astro.site?.origin ?? requestUrl?.origin ?? fallbackSite;
const canonical =
  seo?.canonical ??
  (requestUrl
    ? new URL(requestUrl.pathname, siteOrigin).toString()
    : undefined);

const resolveUrl = (value: string) => {
  try {
    return new URL(value, siteOrigin).toString();
  } catch {
    return value;
  }
};

const absoluteImage = seo?.image?.src ? resolveUrl(seo.image.src) : undefined;

const articleData: Record<string, string | string[]> = {};
if (seo?.publishedTime) {
  articleData.publishedTime = seo.publishedTime;
}
if (seo?.modifiedTime) {
  articleData.modifiedTime = seo.modifiedTime;
}
if (seo?.tags && seo.tags.length > 0) {
  articleData.tags = seo.tags;
}

const openGraph =
  absoluteImage && canonical
    ? {
        basic: {
          title,
          type: seo?.type ?? "website",
          image: absoluteImage,
          url: canonical,
        },
        optional: {
          siteName: "Jarvis Hub",
          description,
        },
        ...(Object.keys(articleData).length > 0
          ? {
              article: articleData,
            }
          : {}),
      }
    : undefined;

const twitterBase: TwitterConfig = {
  card: absoluteImage ? "summary_large_image" : "summary",
  title,
  description,
};

if (absoluteImage) {
  twitterBase.image = absoluteImage;
  twitterBase.imageAlt = seo?.image?.alt ?? title;
}

const twitterConfig = {
  ...twitterBase,
  ...(seo?.twitter ?? {}),
};

const structuredData = seo?.structuredData;
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#030712" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Jarvis Hub – Writing"
      href="/rss.xml"
    />

    <SEO
      title={title}
      description={description}
      canonical={canonical ?? undefined}
      noindex={seo?.noindex}
      openGraph={openGraph}
      twitter={twitterConfig}
    />

    {
      structuredData && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(structuredData)}
        />
      )
    }
  </head>
  <body
    class="relative min-h-screen overflow-x-hidden bg-background text-primary selection:bg-accent-cyan/30 selection:text-accent-cyan"
  >
    <!-- Background Effects -->
    <div class="fixed inset-0 z-[-1] pointer-events-none">
      <div
        class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-accent-violet/20 blur-[120px] opacity-50 animate-pulse"
      >
      </div>
      <div
        class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-accent-cyan/20 blur-[120px] opacity-50 animate-pulse delay-1000"
      >
      </div>
      <div
        class="absolute inset-0 bg-[url('/noise.png')] opacity-[0.03] mix-blend-overlay"
      >
      </div>
    </div>

    <a
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-50 px-4 py-2 bg-surface text-white rounded-md"
      href="#main">Skip to content</a
    >

    <!-- Language Switcher (Top Right) -->
    <a
      href={lang === "en" ? "/zh" : "/"}
      class="fixed top-6 right-6 z-50 hidden md:flex items-center justify-center px-4 py-2 text-xs font-pixel text-white bg-black/50 backdrop-blur-md border border-white/20 rounded hover:border-accent-cyan hover:text-accent-cyan transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] hover:shadow-[2px_2px_0px_0px_rgba(34,211,238,0.5)] hover:translate-y-[2px] hover:translate-x-[2px]"
    >
      [{lang === "en" ? "中文" : "EN"}]
    </a>

    <header class="fixed top-6 left-0 right-0 z-40 flex justify-center px-4">
      <div class="glass-panel rounded-full px-6 py-3 flex items-center gap-8">
        <a
          class="font-display font-bold text-lg tracking-tight flex items-center gap-2 hover:text-accent-cyan transition-colors"
          href={lang === "en" ? "/" : "/zh"}
        >
          <span
            class="w-2 h-2 rounded-full bg-accent-cyan shadow-[0_0_10px_rgba(34,211,238,0.8)]"
          ></span>
          Jarvis Hub
        </a>

        <nav class="hidden md:flex items-center gap-6">
          {
            navLinks.map(({ href, label }) => (
              <a
                href={href}
                class="text-sm font-medium text-secondary hover:text-white transition-colors relative group"
              >
                {label}
                <span class="absolute -bottom-1 left-0 w-0 h-[2px] bg-gradient-to-r from-accent-cyan to-accent-violet transition-all duration-300 group-hover:w-full" />
              </a>
            ))
          }
          <a
            class="hidden md:inline-flex items-center justify-center px-4 py-1.5 text-sm font-semibold text-background bg-white rounded-full hover:bg-accent-cyan transition-colors duration-300"
            href="#contact"
          >
            {t("nav.contact")}
          </a>
        </nav>

        <!-- Mobile Menu Button -->
        <button
          id="menu-btn"
          class="md:hidden text-white z-50 relative group"
          aria-label="Menu"
        >
          <div class="w-6 h-5 flex flex-col justify-between">
            <span
              class="w-full h-0.5 bg-white transition-all duration-300 group-hover:bg-accent-cyan origin-left"
            ></span>
            <span
              class="w-full h-0.5 bg-white transition-all duration-300 group-hover:bg-accent-cyan"
            ></span>
            <span
              class="w-full h-0.5 bg-white transition-all duration-300 group-hover:bg-accent-cyan origin-left"
            ></span>
          </div>
        </button>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div
      id="mobile-menu"
      class="fixed inset-0 z-40 bg-black/95 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    >
      <div
        class="absolute inset-0 bg-[url('/grid.svg')] opacity-10 pointer-events-none"
      >
      </div>
      <nav class="flex flex-col items-center gap-8 relative z-10">
        {
          navLinks.map(({ href, label }) => (
            <a
              href={href}
              class="mobile-link text-4xl font-pixel text-white hover:text-accent-cyan transition-colors uppercase tracking-widest"
            >
              {label}
            </a>
          ))
        }
        <a
          href="mailto:hello@jarvishub.com"
          class="mt-8 px-8 py-4 border-2 border-accent-cyan text-accent-cyan font-pixel uppercase tracking-widest hover:bg-accent-cyan hover:text-black transition-all"
        >
          INITIATE_CONTACT
        </a>
      </nav>
    </div>

    <script>
      // Mobile Menu Logic
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const mobileLinks = document.querySelectorAll(".mobile-link");

      let isMenuOpen = false;

      function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
          mobileMenu?.classList.remove("opacity-0", "pointer-events-none");
          document.body.style.overflow = "hidden";
          // Animate burger icon
          const spans = menuBtn?.querySelectorAll("span");
          if (spans) {
            spans[0].style.transform = "rotate(45deg)";
            spans[1].style.opacity = "0";
            spans[2].style.transform = "rotate(-45deg)";
          }
        } else {
          mobileMenu?.classList.add("opacity-0", "pointer-events-none");
          document.body.style.overflow = "";
          // Reset burger icon
          const spans = menuBtn?.querySelectorAll("span");
          if (spans) {
            spans[0].style.transform = "rotate(0)";
            spans[1].style.opacity = "1";
            spans[2].style.transform = "rotate(0)";
          }
        }
      }

      menuBtn?.addEventListener("click", toggleMenu);

      // Close menu when clicking a link
      mobileLinks.forEach((link) => {
        link.addEventListener("click", () => {
          if (isMenuOpen) toggleMenu();
        });
      });

      // Scroll Reveal Observer
      const observerOptions = {
        root: null,
        rootMargin: "0px",
        threshold: 0.1,
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("reveal-visible");
            observer.unobserve(entry.target); // Only animate once
          }
        });
      }, observerOptions);

      document.querySelectorAll(".reveal-on-scroll").forEach((el) => {
        observer.observe(el);
      });
    </script>

    <main id="main" class="flex-1 pt-32 px-4 md:px-8 max-w-7xl mx-auto w-full">
      <slot />
    </main>

    <footer
      class="border-t-2 border-dashed border-white/10 mt-24 bg-black/80 backdrop-blur-md relative overflow-hidden"
    >
      {/* Scanline overlay for footer */}
      <div
        class="absolute inset-0 pointer-events-none bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%] opacity-20"
      >
      </div>

      <div
        class="max-w-7xl mx-auto px-6 py-8 flex flex-col md:flex-row justify-between items-center gap-6 relative z-10"
      >
        {/* System Status */}
        <div
          class="flex items-center gap-4 text-[10px] font-pixel text-secondary uppercase tracking-widest"
        >
          <div
            class="flex items-center gap-2 px-2 py-1 bg-green-900/20 border border-green-500/30 text-green-400 rounded-sm"
          >
            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"
            ></span>
            {t("footer.system")}
          </div>
          <div class="hidden sm:block text-white/30">{t("footer.latency")}</div>
        </div>

        {/* Copyright */}
        <div
          class="text-[10px] font-pixel text-white/40 uppercase tracking-widest text-center"
        >
          {t("footer.rights")}
        </div>

        {/* Social Links */}
        <div class="flex items-center gap-6">
          <a
            href="https://github.com/Jarvis636431"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[10px] font-pixel text-secondary hover:text-accent-cyan transition-colors uppercase tracking-widest group"
          >
            [GITHUB]
            <span class="hidden group-hover:inline animate-pulse">_</span>
          </a>
          <a
            href="mailto:hello@jarvishub.com"
            class="text-[10px] font-pixel text-secondary hover:text-accent-cyan transition-colors uppercase tracking-widest group"
          >
            [EMAIL]
            <span class="hidden group-hover:inline animate-pulse">_</span>
          </a>
        </div>
      </div>
    </footer>
  </body>
</html>
