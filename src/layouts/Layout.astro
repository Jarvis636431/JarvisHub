---
import { SEO } from "astro-seo";
import "../styles/global.css";
import Search from "../components/Search.astro";

type NavLink = { href: string; label: string };
type StructuredData = Record<string, unknown> | Record<string, unknown>[];

type TwitterConfig = {
  card?: "summary" | "summary_large_image" | "player" | "app";
  site?: string;
  creator?: string;
  image?: string;
  imageAlt?: string;
  title?: string;
  description?: string;
};

interface SeoConfig {
  canonical?: string;
  type?: string;
  image?: {
    src: string;
    alt?: string;
  };
  noindex?: boolean;
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  twitter?: TwitterConfig;
  structuredData?: StructuredData;
}

interface LayoutProps {
  title?: string;
  description?: string;
  navLinks?: NavLink[];
  footerNote?: string;
  seo?: SeoConfig;
}

const fallbackSite = "https://jarvishub.com";

const {
  title = "Jarvis Hub - Creative Developer",
  description = "Personal website of Jarvis - crafting web experiences, writing, and sharing experiments in code.",
  navLinks = [
    { href: "/projects", label: "Projects" },
    { href: "/blog", label: "Writing" },
  ],
  footerNote = "Built with Astro - Designed by Jarvis",
  seo,
} = Astro.props as LayoutProps;

const requestUrl = Astro.url;
const siteOrigin = Astro.site?.origin ?? requestUrl?.origin ?? fallbackSite;
const canonical =
  seo?.canonical ??
  (requestUrl
    ? new URL(requestUrl.pathname, siteOrigin).toString()
    : undefined);

const resolveUrl = (value: string) => {
  try {
    return new URL(value, siteOrigin).toString();
  } catch {
    return value;
  }
};

const absoluteImage = seo?.image?.src ? resolveUrl(seo.image.src) : undefined;

const articleData: Record<string, string | string[]> = {};
if (seo?.publishedTime) {
  articleData.publishedTime = seo.publishedTime;
}
if (seo?.modifiedTime) {
  articleData.modifiedTime = seo.modifiedTime;
}
if (seo?.tags && seo.tags.length > 0) {
  articleData.tags = seo.tags;
}

const openGraph =
  absoluteImage && canonical
    ? {
        basic: {
          title,
          type: seo?.type ?? "website",
          image: absoluteImage,
          url: canonical,
        },
        optional: {
          siteName: "Jarvis Hub",
          description,
        },
        ...(Object.keys(articleData).length > 0
          ? { article: articleData }
          : {}),
      }
    : undefined;

const twitterBase: TwitterConfig = {
  card: absoluteImage ? "summary_large_image" : "summary",
  title,
  description,
};

if (absoluteImage) {
  twitterBase.image = absoluteImage;
  twitterBase.imageAlt = seo?.image?.alt ?? title;
}

const twitterConfig = {
  ...twitterBase,
  ...(seo?.twitter ?? {}),
};

const structuredData = seo?.structuredData;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#030712" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Jarvis Hub – Writing"
      href="/rss.xml"
    />
    <SEO
      title={title}
      description={description}
      canonical={canonical ?? undefined}
      noindex={seo?.noindex}
      openGraph={openGraph}
      twitter={twitterConfig}
    />
    {
      structuredData && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(structuredData)}
        />
      )
    }
  </head>
  <body
    class="relative min-h-screen overflow-x-hidden bg-background text-primary selection:bg-accent-cyan/30 selection:text-accent-cyan"
  >
    <!-- Background Effects -->
    <div class="fixed inset-0 z-[-1] pointer-events-none">
      <div
        class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-accent-violet/20 blur-[120px] opacity-50 animate-pulse"
      >
      </div>
      <div
        class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-accent-cyan/20 blur-[120px] opacity-50 animate-pulse delay-1000"
      >
      </div>
      <div
        class="absolute inset-0 bg-[url('/noise.png')] opacity-[0.03] mix-blend-overlay"
      >
      </div>
    </div>

    <a
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-50 px-4 py-2 bg-surface text-white rounded-md"
      href="#main">Skip to content</a
    >

    <!-- GitHub Corner Icon -->
    <a
      href="https://github.com/Jarvis636431"
      target="_blank"
      rel="noopener noreferrer"
      class="fixed top-6 right-6 z-50 group"
      aria-label="View source on GitHub"
    >
      <div
        class="relative w-12 h-12 rounded-full bg-surface/80 backdrop-blur-sm border border-white/10 flex items-center justify-center hover:border-accent-cyan transition-all duration-300 hover:scale-110 hover:shadow-[0_0_20px_rgba(34,211,238,0.3)]"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="text-secondary group-hover:text-accent-cyan transition-colors duration-300"
        >
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
          ></path>
        </svg>
      </div>
    </a>

    <header
      id="main-header"
      class="fixed top-6 left-0 right-0 z-40 flex justify-center px-4 transition-opacity duration-300"
    >
      <div class="glass-panel rounded-full px-6 py-3 flex items-center gap-8">
        <a
          class="font-display font-bold text-lg tracking-tight flex items-center gap-2 hover:text-accent-cyan transition-colors"
          href="/"
        >
          <span
            class="w-2 h-2 rounded-full bg-accent-cyan shadow-[0_0_10px_rgba(34,211,238,0.8)]"
          ></span>
          Jarvis Hub
        </a>
        <nav class="hidden md:flex items-center gap-6" aria-label="Primary">
          {
            navLinks.map(({ href, label }) => {
              const currentPath = Astro.url.pathname;
              const isActive = currentPath === href || currentPath.startsWith(`${href}/`);
              return (
                <a
                  href={href}
                  aria-current={isActive ? "page" : undefined}
                  class={`text-sm font-medium transition-colors relative group ${
                    isActive ? "text-white" : "text-secondary hover:text-white"
                  }`}
                >
                  {label}
                  <span class={`absolute -bottom-1 left-0 h-[2px] bg-gradient-to-r from-accent-cyan to-accent-violet transition-all duration-300 ${
                    isActive ? "w-full" : "w-0 group-hover:w-full"
                  }`} />
                </a>
              );
            })
          }
        </nav>

        <button
          onclick="window.openSearch()"
          class="hidden md:flex items-center justify-center text-secondary hover:text-accent-cyan transition-colors"
          aria-label="Search"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
            ></path></svg
          >
        </button>

        <a
          class="hidden md:inline-flex items-center justify-center px-4 py-1.5 text-sm font-semibold text-background bg-white rounded-full hover:bg-accent-cyan transition-colors duration-300"
          href="#contact"
        >
          Let's talk
        </a>

        <!-- Mobile Menu Button -->
        <button
          id="menu-btn"
          class="md:hidden text-white z-50 relative group"
          aria-label="Menu"
        >
          <div class="w-6 h-5 flex flex-col justify-between">
            <span
              class="w-full h-0.5 bg-white transition-all duration-300 group-hover:bg-accent-cyan origin-left"
            ></span>
            <span
              class="w-full h-0.5 bg-white transition-all duration-300 group-hover:bg-accent-cyan"
            ></span>
            <span
              class="w-full h-0.5 bg-white transition-all duration-300 group-hover:bg-accent-cyan origin-left"
            ></span>
          </div>
        </button>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div
      id="mobile-menu"
      class="fixed inset-0 z-40 bg-black/95 backdrop-blur-xl flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    >
      <div
        class="absolute inset-0 bg-[url('/grid.svg')] opacity-10 pointer-events-none"
      >
      </div>
      <nav class="flex flex-col items-center gap-8 relative z-10">
        {
          navLinks.map(({ href, label }) => (
            <a
              href={href}
              class="mobile-link text-4xl font-pixel text-white hover:text-accent-cyan transition-colors uppercase"
            >
              {label}
            </a>
          ))
        }
        <a
          href="mailto:hello@jarvishub.com"
          class="mt-8 px-8 py-4 border-2 border-accent-cyan text-accent-cyan font-pixel uppercase hover:bg-accent-cyan hover:text-black transition-all"
        >
          INITIATE_CONTACT
        </a>

        <button
          onclick="window.openSearch()"
          class="mt-4 text-secondary hover:text-white flex items-center gap-2 font-pixel text-xs uppercase"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
            ></path></svg
          >
          [SEARCH_DATABASE]
        </button>
      </nav>
    </div>

    <script>
      // Mobile Menu Logic
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const mobileLinks = document.querySelectorAll(".mobile-link");
      let isMenuOpen = false;

      function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
          mobileMenu?.classList.remove("opacity-0", "pointer-events-none");
          document.body.style.overflow = "hidden";
          // Animate burger icon
          const spans = menuBtn?.querySelectorAll("span");
          if (spans) {
            spans[0].style.transform = "rotate(45deg)";
            spans[1].style.opacity = "0";
            spans[2].style.transform = "rotate(-45deg)";
          }
        } else {
          mobileMenu?.classList.add("opacity-0", "pointer-events-none");
          document.body.style.overflow = "";
          // Reset burger icon
          const spans = menuBtn?.querySelectorAll("span");
          if (spans) {
            spans[0].style.transform = "rotate(0)";
            spans[1].style.opacity = "1";
            spans[2].style.transform = "rotate(0)";
          }
        }
      }

      menuBtn?.addEventListener("click", toggleMenu);

      // Close menu when clicking a link
      mobileLinks.forEach((link) => {
        link.addEventListener("click", () => {
          if (isMenuOpen) toggleMenu();
        });
      });

      // Scroll Reveal Observer
      const observerOptions = {
        root: null,
        rootMargin: "0px",
        threshold: 0.1,
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("reveal-visible");
            observer.unobserve(entry.target); // Only animate once
          }
        });
      }, observerOptions);

      document.querySelectorAll(".reveal-on-scroll").forEach((el) => {
        observer.observe(el);
      });
    </script>

    <main id="main" class="flex-1 pt-32 px-4 md:px-8 max-w-7xl mx-auto w-full">
      <slot />
    </main>

    <footer
      class="border-t-2 border-dashed border-white/10 mt-24 bg-black/80 backdrop-blur-md relative overflow-hidden"
    >
      {/* Scanline overlay for footer */}
      <div
        class="absolute inset-0 pointer-events-none bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,3px_100%] opacity-20"
      >
      </div>

      <div
        class="max-w-7xl mx-auto px-6 py-8 flex flex-col md:flex-row justify-between items-center gap-6 relative z-10"
      >
        {/* System Status */}
        <div
          class="flex items-center gap-4 text-[10px] font-pixel text-secondary uppercase"
        >
          <div
            class="flex items-center gap-2 px-2 py-1 bg-green-900/20 border border-green-500/30 text-green-400 rounded-sm"
          >
            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"
            ></span>
            SYSTEM: ONLINE
          </div>
          <div class="hidden sm:block text-white/30">LATENCY: 24ms</div>
        </div>

        {/* Copyright */}
        <div class="text-[10px] font-pixel text-white/40 uppercase text-center">
          © 2024 JARVIS_HUB // ALL RIGHTS RESERVED
        </div>

        {/* Social Links */}
        <div class="flex items-center gap-6">
          <a
            href="https://github.com/Jarvis636431"
            target="_blank"
            rel="noopener noreferrer"
            class="text-[10px] font-pixel text-secondary hover:text-accent-cyan transition-colors uppercase group"
          >
            [GITHUB] <span class="hidden group-hover:inline animate-pulse"
              >_</span
            >
          </a>
          <a
            href="mailto:hello@jarvishub.com"
            class="text-[10px] font-pixel text-secondary hover:text-accent-cyan transition-colors uppercase group"
          >
            [EMAIL] <span class="hidden group-hover:inline animate-pulse"
              >_</span
            >
          </a>
        </div>
      </div>
    </footer>
  </body><Search />
</html>
