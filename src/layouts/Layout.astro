---
import { SEO } from "astro-seo";
import "../styles/global.css";
import Search from "../components/Search.astro";

type NavLink = { href: string; label: string };
type StructuredData = Record<string, unknown> | Record<string, unknown>[];

type TwitterConfig = {
  card?: "summary" | "summary_large_image" | "player" | "app";
  site?: string;
  creator?: string;
  image?: string;
  imageAlt?: string;
  title?: string;
  description?: string;
};

interface SeoConfig {
  canonical?: string;
  type?: string;
  image?: {
    src: string;
    alt?: string;
  };
  noindex?: boolean;
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  twitter?: TwitterConfig;
  structuredData?: StructuredData;
}

interface LayoutProps {
  title?: string;
  description?: string;
  navLinks?: NavLink[];
  footerNote?: string;
  seo?: SeoConfig;
}

const fallbackSite = "https://jarvishub.com";

const {
  title = "Jarvis Hub - Creative Developer",
  description = "Personal website of Jarvis - crafting web experiences, writing, and sharing experiments in code.",
  navLinks = [
    { href: "/projects", label: "Projects" },
    { href: "/blog", label: "Writing" },
  ],
  footerNote = "Built with Astro - Designed by Jarvis",
  seo,
} = Astro.props as LayoutProps;

const requestUrl = Astro.url;
const siteOrigin = Astro.site?.origin ?? requestUrl?.origin ?? fallbackSite;
const canonical =
  seo?.canonical ??
  (requestUrl
    ? new URL(requestUrl.pathname, siteOrigin).toString()
    : undefined);

const resolveUrl = (value: string) => {
  try {
    return new URL(value, siteOrigin).toString();
  } catch {
    return value;
  }
};

const absoluteImage = seo?.image?.src ? resolveUrl(seo.image.src) : undefined;

const articleData: Record<string, string | string[]> = {};
if (seo?.publishedTime) {
  articleData.publishedTime = seo.publishedTime;
}
if (seo?.modifiedTime) {
  articleData.modifiedTime = seo.modifiedTime;
}
if (seo?.tags && seo.tags.length > 0) {
  articleData.tags = seo.tags;
}

const openGraph =
  absoluteImage && canonical
    ? {
        basic: {
          title,
          type: seo?.type ?? "website",
          image: absoluteImage,
          url: canonical,
        },
        optional: {
          siteName: "Jarvis Hub",
          description,
        },
        ...(Object.keys(articleData).length > 0
          ? { article: articleData }
          : {}),
      }
    : undefined;

const twitterBase: TwitterConfig = {
  card: absoluteImage ? "summary_large_image" : "summary",
  title,
  description,
};

if (absoluteImage) {
  twitterBase.image = absoluteImage;
  twitterBase.imageAlt = seo?.image?.alt ?? title;
}

const twitterConfig = {
  ...twitterBase,
  ...(seo?.twitter ?? {}),
};

const structuredData = seo?.structuredData;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#030712" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Jarvis Hub – Writing"
      href="/rss.xml"
    />
    <SEO
      title={title}
      description={description}
      canonical={canonical ?? undefined}
      noindex={seo?.noindex}
      openGraph={openGraph}
      twitter={twitterConfig}
    />
    {
      structuredData && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(structuredData)}
        />
      )
    }
  </head>
  <body
    class="relative min-h-screen overflow-x-hidden bg-background text-primary selection:bg-accent-cyan/20 selection:text-primary"
  >
    <div
      class="fixed inset-0 -z-10 bg-[radial-gradient(circle_at_top_left,rgba(47,111,109,0.12),transparent_55%),radial-gradient(circle_at_bottom_right,rgba(197,154,109,0.12),transparent_50%)]"
    >
    </div>
    <a
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-50 px-4 py-2 bg-surface text-primary rounded-md border border-black/10"
      href="#main">Skip to content</a
    >

    <header
      id="main-header"
      class="sticky top-0 z-40 border-b border-black/10 bg-background/90 backdrop-blur transition-opacity duration-300"
    >
      <div
        class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-6"
      >
        <a
          class="font-display font-semibold text-lg tracking-tight hover:text-accent-cyan transition-colors"
          href="/"
        >
          Jarvis Hub
        </a>
        <nav
          class="hidden md:flex items-center gap-6 text-sm"
          aria-label="Primary"
        >
          {
            navLinks.map(({ href, label }) => {
              const currentPath = Astro.url.pathname;
              const isActive =
                currentPath === href || currentPath.startsWith(`${href}/`);
              return (
                <a
                  href={href}
                  aria-current={isActive ? "page" : undefined}
                  class={`transition-colors ${
                    isActive
                      ? "text-primary"
                      : "text-secondary hover:text-primary"
                  }`}
                >
                  {label}
                </a>
              );
            })
          }
        </nav>

        <div class="flex items-center gap-3">
          <button
            onclick="window.openSearch()"
            class="hidden md:flex items-center justify-center text-secondary hover:text-accent-cyan transition-colors"
            aria-label="Search"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
              ></path></svg
            >
          </button>

          <a
            href="https://github.com/jarvishub"
            target="_blank"
            rel="noreferrer"
            class="hidden md:flex items-center justify-center text-secondary hover:text-accent-cyan transition-colors"
            aria-label="GitHub"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
              ></path>
            </svg>
          </a>

          <!-- Mobile Menu Button -->
          <button
            id="menu-btn"
            class="md:hidden text-primary z-50 relative"
            aria-label="Menu"
          >
            <div class="w-6 h-5 flex flex-col justify-between">
              <span
                class="w-full h-0.5 bg-primary transition-all duration-300 origin-left"
              ></span>
              <span class="w-full h-0.5 bg-primary transition-all duration-300"
              ></span>
              <span
                class="w-full h-0.5 bg-primary transition-all duration-300 origin-left"
              ></span>
            </div>
          </button>
        </div>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div
      id="mobile-menu"
      class="fixed inset-0 z-40 bg-black/20 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
    >
      <nav
        class="flex flex-col items-center gap-6 bg-surface border border-black/10 rounded-2xl px-10 py-8 shadow-lg"
      >
        {
          navLinks.map(({ href, label }) => (
            <a
              href={href}
              class="mobile-link text-xl font-display text-primary hover:text-accent-cyan transition-colors"
            >
              {label}
            </a>
          ))
        }
        <a
          href="mailto:hello@jarvishub.com"
          class="mt-4 px-6 py-2 border border-accent-cyan text-accent-cyan rounded-full hover:bg-accent-cyan hover:text-white transition-all"
        >
          Email
        </a>

        <button
          onclick="window.openSearch()"
          class="mt-2 text-secondary hover:text-primary flex items-center gap-2 text-xs uppercase tracking-wide"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
            ></path></svg
          >
          Search
        </button>
      </nav>
    </div>

    <script>
      // Mobile Menu Logic
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const mobileLinks = document.querySelectorAll(".mobile-link");
      let isMenuOpen = false;

      function toggleMenu() {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
          mobileMenu?.classList.remove("opacity-0", "pointer-events-none");
          document.body.style.overflow = "hidden";
          // Animate burger icon
          const spans = menuBtn?.querySelectorAll("span");
          if (spans) {
            spans[0].style.transform = "rotate(45deg)";
            spans[1].style.opacity = "0";
            spans[2].style.transform = "rotate(-45deg)";
          }
        } else {
          mobileMenu?.classList.add("opacity-0", "pointer-events-none");
          document.body.style.overflow = "";
          // Reset burger icon
          const spans = menuBtn?.querySelectorAll("span");
          if (spans) {
            spans[0].style.transform = "rotate(0)";
            spans[1].style.opacity = "1";
            spans[2].style.transform = "rotate(0)";
          }
        }
      }

      menuBtn?.addEventListener("click", toggleMenu);

      // Close menu when clicking a link
      mobileLinks.forEach((link) => {
        link.addEventListener("click", () => {
          if (isMenuOpen) toggleMenu();
        });
      });
    </script>

    <main id="main" class="flex-1 px-4 md:px-8 max-w-6xl mx-auto w-full">
      <slot />
    </main>

    <footer class="border-t border-black/10 mt-20">
      <div
        class="max-w-6xl mx-auto px-4 py-8 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-secondary"
      >
        <div>© 2024 Jarvis Hub</div>
        <div class="flex items-center gap-6">
          <a
            href="https://github.com/jarvishub"
            target="_blank"
            rel="noopener noreferrer"
            class="text-secondary hover:text-accent-cyan transition-colors"
          >
            GitHub
          </a>
          <a
            href="mailto:hello@jarvishub.com"
            class="text-secondary hover:text-accent-cyan transition-colors"
          >
            Email
          </a>
        </div>
      </div>
    </footer>
  </body><Search />
</html>
