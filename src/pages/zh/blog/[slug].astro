---
import Layout from "@layouts/Layout.astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const posts = await getCollection("blog", ({ data }) =>
        import.meta.env.DEV ? true : data.draft !== true,
    );
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

const { post } = Astro.props as { post: CollectionEntry<"blog"> };
const { Content } = await post.render();

const publishDate = new Date(post.data.publishDate).toLocaleDateString(
    "zh-CN",
    {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
    },
);
const readingTime = post.data.readingTime ?? 6;

const publishDateIso = new Date(post.data.publishDate).toISOString();
const updatedDateIso = post.data.updatedDate
    ? new Date(post.data.updatedDate).toISOString()
    : undefined;

const siteOrigin =
    Astro.site?.origin ?? Astro.url.origin ?? "https://jarvishub.com";
const canonicalUrl = new URL(Astro.url.pathname, siteOrigin).toString();
const heroImageUrl = post.data.heroImage
    ? new URL(post.data.heroImage, siteOrigin).toString()
    : undefined;

const articleStructuredData: Record<string, unknown> = {
    "@context": "https://schema.org",
    "@type": "Article",
    headline: post.data.title,
    description: post.data.description,
    datePublished: publishDateIso,
    dateModified: updatedDateIso ?? publishDateIso,
    author: {
        "@type": "Person",
        name: "Jarvis Hub",
    },
    publisher: {
        "@type": "Organization",
        name: "Jarvis Hub",
        logo: {
            "@type": "ImageObject",
            url: new URL("/favicon.svg", siteOrigin).toString(),
        },
    },
    mainEntityOfPage: canonicalUrl,
    url: canonicalUrl,
    inLanguage: "zh-CN",
};

if (heroImageUrl) {
    articleStructuredData.image = [heroImageUrl];
}

if (post.data.tags.length > 0) {
    articleStructuredData.keywords = post.data.tags.join(", ");
}
---

<Layout
    title={`${post.data.title} - Jarvis Hub`}
    description={post.data.description}
    lang="zh"
    seo={{
        canonical: canonicalUrl,
        type: "article",
        image: post.data.heroImage
            ? {
                  src: post.data.heroImage,
                  alt: post.data.title,
              }
            : undefined,
        publishedTime: publishDateIso,
        modifiedTime: updatedDateIso,
        tags: post.data.tags,
        structuredData: articleStructuredData,
    }}
>
    <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        {/* Header Section */}
        <header
            class="mb-16 space-y-8 border-b-4 border-white/10 pb-12 relative"
        >
            <div
                class="absolute top-0 right-0 text-[10px] font-pixel text-white/20 hidden md:block"
            >
                文档ID: {post.slug.toUpperCase()}
            </div>

            <a
                href="/zh/blog"
                class="inline-flex items-center gap-2 text-xs font-pixel text-accent-cyan hover:text-accent-violet transition-colors uppercase tracking-widest group"
            >
                <span class="group-hover:-translate-x-1 transition-transform"
                    >{"<-"}</span
                >
                访问归档
            </a>

            <div class="space-y-4">
                <div
                    class="flex flex-wrap gap-4 text-xs font-mono text-secondary"
                >
                    <span class="px-2 py-1 bg-white/5 border border-white/10">
                        > 记录日期: {publishDate}
                    </span>
                    <span class="px-2 py-1 bg-white/5 border border-white/10">
                        > 预计阅读: {readingTime} 分钟
                    </span>
                </div>

                <h1
                    class="text-3xl md:text-5xl lg:text-6xl font-bold font-pixel leading-tight text-white drop-shadow-[4px_4px_0px_rgba(167,139,250,0.5)]"
                >
                    {post.data.title}
                </h1>

                <p
                    class="text-xl md:text-2xl text-secondary font-light leading-relaxed border-l-4 border-accent-cyan pl-6"
                >
                    {post.data.description}
                </p>
            </div>

            {
                post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-3">
                        {post.data.tags.map((tag) => (
                            <span class="px-3 py-1 bg-accent-violet/10 border border-accent-violet/30 text-accent-violet text-xs font-pixel uppercase">
                                #{tag}
                            </span>
                        ))}
                    </div>
                )
            }

            {
                post.data.heroImage && (
                    <div class="relative mt-8 group">
                        <div class="absolute inset-0 bg-accent-cyan/20 translate-x-2 translate-y-2 group-hover:translate-x-3 group-hover:translate-y-3 transition-transform duration-300" />
                        <img
                            class="relative w-full h-auto border-2 border-white/20 image-pixelated grayscale group-hover:grayscale-0 transition-all duration-500"
                            src={post.data.heroImage}
                            alt={post.data.title}
                            loading="eager"
                        />
                        <div class="absolute bottom-0 right-0 bg-black/80 px-4 py-2 border-t-2 border-l-2 border-white/20 text-[10px] font-pixel text-white">
                            图片来源: 外部
                        </div>
                    </div>
                )
            }
        </header>

        {/* Content Section */}
        <div class="prose-pixel">
            <Content />
        </div>

        {/* Footer / End of Log */}
        <div
            class="mt-16 pt-8 border-t-2 border-dashed border-white/10 text-center"
        >
            <span
                class="inline-block px-4 py-2 bg-white/5 text-xs font-pixel text-secondary animate-pulse"
            >
                *** 传输结束 ***
            </span>
        </div>
    </article>
</Layout>

<style is:global>
    /* Custom Prose Styling for Pixel Theme */
    .prose-pixel {
        color: #cbd5e1; /* slate-300 */
        font-family: "Inter", sans-serif;
        font-size: 1.125rem;
        line-height: 1.8;
    }

    .prose-pixel h1,
    .prose-pixel h2,
    .prose-pixel h3,
    .prose-pixel h4 {
        font-family: "Press Start 2P", cursive;
        color: #fff;
        margin-top: 2.5em;
        margin-bottom: 1em;
        line-height: 1.4;
    }

    .prose-pixel h2 {
        font-size: 1.5rem;
        border-bottom: 2px solid rgba(34, 211, 238, 0.3); /* accent-cyan */
        padding-bottom: 0.5em;
        display: inline-block;
    }

    .prose-pixel h3 {
        font-size: 1.1rem;
        color: #22d3ee; /* accent-cyan */
    }

    .prose-pixel p {
        margin-bottom: 1.5em;
    }

    .prose-pixel a {
        color: #22d3ee;
        text-decoration: none;
        border-bottom: 2px solid rgba(34, 211, 238, 0.3);
        transition: all 0.2s;
    }

    .prose-pixel a:hover {
        background: rgba(34, 211, 238, 0.1);
        border-color: #22d3ee;
    }

    .prose-pixel ul,
    .prose-pixel ol {
        margin-bottom: 1.5em;
        padding-left: 1.5em;
    }

    .prose-pixel li {
        margin-bottom: 0.5em;
        position: relative;
    }

    .prose-pixel ul li::before {
        content: ">";
        position: absolute;
        left: -1.5em;
        color: #a78bfa; /* accent-violet */
        font-family: monospace;
        font-weight: bold;
    }

    .prose-pixel blockquote {
        border-left: 4px solid #a78bfa;
        background: rgba(167, 139, 250, 0.05);
        padding: 1em 1.5em;
        margin-bottom: 1.5em;
        font-style: italic;
        color: #e2e8f0;
    }

    .prose-pixel code {
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 0.9em;
        background: #000;
        color: #22d3ee;
        padding: 0.2em 0.4em;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .prose-pixel pre {
        background: #020617; /* slate-950 */
        border: 2px solid rgba(255, 255, 255, 0.1);
        padding: 1.5em;
        overflow-x: auto;
        margin-bottom: 2em;
        box-shadow: 4px 4px 0px 0px rgba(255, 255, 255, 0.05);
    }

    .prose-pixel pre code {
        background: transparent;
        border: none;
        color: inherit;
        padding: 0;
    }

    .prose-pixel img {
        border: 2px solid rgba(255, 255, 255, 0.1);
        margin: 2em 0;
        width: 100%;
        height: auto;
    }
</style>
