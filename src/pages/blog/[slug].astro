---
import Layout from "@layouts/Layout.astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) =>
    import.meta.env.DEV ? true : data.draft !== true,
  );
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: CollectionEntry<"blog"> };
const { Content } = await post.render();

const publishDate = new Date(post.data.publishDate).toLocaleDateString(
  "en-US",
  {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  },
);
const readingTime = post.data.readingTime ?? 6;

const publishDateIso = new Date(post.data.publishDate).toISOString();
const updatedDateIso = post.data.updatedDate
  ? new Date(post.data.updatedDate).toISOString()
  : undefined;

const siteOrigin =
  Astro.site?.origin ?? Astro.url.origin ?? "https://jarvishub.com";
const canonicalUrl = new URL(Astro.url.pathname, siteOrigin).toString();
const heroImageUrl = post.data.heroImage
  ? new URL(post.data.heroImage, siteOrigin).toString()
  : undefined;

const articleStructuredData: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.data.title,
  description: post.data.description,
  datePublished: publishDateIso,
  dateModified: updatedDateIso ?? publishDateIso,
  author: {
    "@type": "Person",
    name: "Jarvis Hub",
  },
  publisher: {
    "@type": "Organization",
    name: "Jarvis Hub",
    logo: {
      "@type": "ImageObject",
      url: new URL("/favicon.svg", siteOrigin).toString(),
    },
  },
  mainEntityOfPage: canonicalUrl,
  url: canonicalUrl,
  inLanguage: "en-US",
};

if (heroImageUrl) {
  articleStructuredData.image = [heroImageUrl];
}

if (post.data.tags.length > 0) {
  articleStructuredData.keywords = post.data.tags.join(", ");
}
// Compute previous/next posts (sorted by publishDate desc)
const allPosts = (
  await getCollection("blog", ({ data }) =>
    import.meta.env.DEV ? true : data.draft !== true,
  )
)
  .slice()
  .sort(
    (a, b) =>
      new Date(b.data.publishDate).getTime() -
      new Date(a.data.publishDate).getTime(),
  );
const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : undefined;
const nextPost =
  currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : undefined;
---

<Layout
  title={`${post.data.title} - Jarvis Hub`}
  description={post.data.description}
  seo={{
    canonical: canonicalUrl,
    type: "article",
    image: post.data.heroImage
      ? {
          src: post.data.heroImage,
          alt: post.data.title,
        }
      : undefined,
    publishedTime: publishDateIso,
    modifiedTime: updatedDateIso,
    tags: post.data.tags,
    structuredData: articleStructuredData,
  }}
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {/* Header Section */}
    <header class="mb-16 space-y-8 border-b-4 border-white/10 pb-12 relative">
      <div
        class="absolute top-0 right-0 text-[10px] font-pixel text-white/20 hidden md:block"
      >
        DOC_ID: {post.slug.toUpperCase()}
      </div>

      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-xs font-pixel text-accent-cyan hover:text-accent-violet transition-colors uppercase tracking-widest group"
      >
        <span class="group-hover:-translate-x-1 transition-transform"
          >{"<-"}</span
        >
        ACCESS_ARCHIVE
      </a>

      <div class="space-y-4">
        <div class="flex flex-wrap gap-4 text-xs font-mono text-secondary">
          <span class="px-2 py-1 bg-white/5 border border-white/10">
            > LOG_DATE: {publishDate}
          </span>
          <span class="px-2 py-1 bg-white/5 border border-white/10">
            > EST_READ: {readingTime} MIN
          </span>
        </div>

        <h1
          class="text-3xl md:text-5xl lg:text-6xl font-bold font-pixel leading-tight text-white drop-shadow-[4px_4px_0px_rgba(167,139,250,0.5)]"
        >
          {post.data.title}
        </h1>

        <p
          class="text-xl md:text-2xl text-secondary font-light leading-relaxed border-l-4 border-accent-cyan pl-6"
        >
          {post.data.description}
        </p>
      </div>

      {
        post.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-3">
            {post.data.tags.map((tag) => (
              <span class="px-3 py-1 bg-accent-violet/10 border border-accent-violet/30 text-accent-violet text-xs font-pixel uppercase">
                #{tag}
              </span>
            ))}
          </div>
        )
      }

      {
        post.data.heroImage && (
          <div class="relative mt-8 group">
            <div class="absolute inset-0 bg-accent-cyan/20 translate-x-2 translate-y-2 group-hover:translate-x-3 group-hover:translate-y-3 transition-transform duration-300" />
            <img
              class="relative w-full h-auto border-2 border-white/20 image-pixelated grayscale group-hover:grayscale-0 transition-all duration-500"
              src={post.data.heroImage}
              alt={post.data.title}
              loading="eager"
            />
            <div class="absolute bottom-0 right-0 bg-black/80 px-4 py-2 border-t-2 border-l-2 border-white/20 text-[10px] font-pixel text-white">
              IMG_SOURCE: EXTERNAL
            </div>
          </div>
        )
      }
    </header>

    <section>
      <div class="blog__content-grid">
        <aside class="blog__toc">
          <div class="blog__toc-title">目录</div>
          <nav id="blog-toc" class="blog__toc-list"></nav>
        </aside>
        <div class="blog__article" id="blog-article">
          <div class="prose-pixel">
            <Content />
          </div>
        </div>
      </div>
    </section>

    {/* Footer / End of Log */}
    <div
      class="mt-16 pt-8 border-t-2 border-dashed border-white/10 text-center"
    >
      {
        (prevPost || nextPost) && (
          <nav
            aria-label="文章导航"
            class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 text-left"
          >
            {
              prevPost && (
                <a
                  href={`/blog/${prevPost.slug}`}
                  class="group block px-4 py-4 bg-white/5 border border-white/10 rounded-lg hover:border-accent-cyan transition-colors"
                >
                  <div class="text-[10px] font-pixel text-secondary uppercase mb-1">
                    上一篇
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <h3 class="text-white font-semibold group-hover:text-accent-cyan transition-colors">
                      {prevPost.data.title}
                    </h3>
                    <span class="text-[10px] font-pixel text-white/40">
                      {new Date(prevPost.data.publishDate).toLocaleDateString("en-US", { year: "numeric", month: "2-digit", day: "2-digit" })}
                    </span>
                  </div>
                </a>
              )
            }
            {
              nextPost && (
                <a
                  href={`/blog/${nextPost.slug}`}
                  class="group block px-4 py-4 bg-white/5 border border-white/10 rounded-lg hover:border-accent-violet transition-colors"
                >
                  <div class="text-[10px] font-pixel text-secondary uppercase mb-1">
                    下一篇
                  </div>
                  <div class="flex items-center justify-between gap-2">
                    <h3 class="text-white font-semibold group-hover:text-accent-violet transition-colors">
                      {nextPost.data.title}
                    </h3>
                    <span class="text-[10px] font-pixel text-white/40">
                      {new Date(nextPost.data.publishDate).toLocaleDateString("en-US", { year: "numeric", month: "2-digit", day: "2-digit" })}
                    </span>
                  </div>
                </a>
              )
            }
          </nav>
        )
      }
      <span
        class="inline-block px-4 py-2 bg-white/5 text-xs font-pixel text-secondary animate-pulse"
      >
        *** END OF TRANSMISSION ***
      </span>
    </div>
  </article>
  <style>
    .blog__content-grid {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 24px;
      align-items: start;
    }

    .blog__toc {
      position: sticky;
      top: 120px;
      align-self: start;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(11, 16, 32, 0.6);
      border-radius: 16px;
      padding: 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06), 0 10px 30px rgba(167,139,250,0.12);
    }

    .blog__toc-title {
      font-size: 0.9rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.7);
      margin: 6px 8px 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed rgba(148,163,184,0.18);
    }

    .blog__toc-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 60vh;
      overflow: auto;
    }

    .blog__toc-item {
      display: block;
      padding: 8px 12px;
      border-left: 2px solid transparent;
      color: rgba(203, 213, 225, 0.9);
      text-decoration: none;
      font-size: 0.95rem;
      border-radius: 8px;
      transition: all 0.15s ease;
    }

    .blog__toc-item::before {
      content: ">";
      margin-right: 8px;
      color: #a78bfa;
    }

    .blog__toc-item.active {
      border-left-color: #22d3ee;
      color: #22d3ee;
      background: rgba(34, 211, 238, 0.06);
    }

    .blog__toc-sub {
      padding-left: 18px;
      font-size: 0.88rem;
      color: rgba(148, 163, 184, 0.85);
    }

    .blog__article h2,
    .blog__article h3 {
      scroll-margin-top: 120px;
    }

    @media (max-width: 720px) {
      .blog__content-grid {
        grid-template-columns: 1fr;
      }
      .blog__toc {
        position: static;
        top: auto;
      }
    }
  </style>
  <script>
    const articleEl = document.getElementById("blog-article");
    const tocEl = document.getElementById("blog-toc");
    if (articleEl && tocEl) {
      const headings = Array.from(articleEl.querySelectorAll("h2, h3"));
      const slugify = (s) => s.toLowerCase().trim().replace(/[^a-z0-9\u4e00-\u9fa5]+/g, "-").replace(/^-+|-+$/g, "");
      const items = [];
      headings.forEach((h) => {
        const text = h.textContent || "";
        const id = h.id || slugify(text);
        if (!h.id) h.id = id;
        items.push({ id, depth: h.tagName === "H2" ? 2 : 3, text });
      });
      const html = items
        .map((i) => `<a href="#${i.id}" class="blog__toc-item ${i.depth === 3 ? "blog__toc-sub" : ""}" data-id="${i.id}">${i.text}</a>`)
        .join("");
      tocEl.innerHTML = html;
      const links = Array.from(tocEl.querySelectorAll(".blog__toc-item"));
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const id = entry.target.id;
            const link = tocEl.querySelector(`.blog__toc-item[data-id="${id}"]`);
            if (link) {
              if (entry.isIntersecting) {
                links.forEach((l) => l.classList.remove("active"));
                link.classList.add("active");
              }
            }
          });
        },
        { rootMargin: "0px 0px -60% 0px", threshold: 0.1 }
      );
      headings.forEach((h) => observer.observe(h));
    }
  </script>
</Layout>
