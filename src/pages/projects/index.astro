---
import Layout from "@layouts/Layout.astro";
import ProjectCard from "@components/ProjectCard.astro";
import { getCollection } from "astro:content";

const projects = (
  await getCollection("projects", ({ data }) =>
    import.meta.env.DEV ? true : data.status !== "archived"
  )
)
  .slice()
  .sort(
    (a, b) =>
      new Date(b.data.publishDate).getTime() -
      new Date(a.data.publishDate).getTime()
  );

const featured = projects.filter(({ data }) => data.featured);
const rest = projects.filter(({ data }) => !data.featured);

const siteOrigin =
  Astro.site?.origin ?? Astro.url.origin ?? "https://jarvishub.com";
const pageUrl = new URL(Astro.url.pathname, siteOrigin).toString();

const projectsStructuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: "Jarvis Hub Projects",
  url: pageUrl,
  description: "Selected client collaborations, experiments, and systems work.",
  inLanguage: "en-US",
};
---

<Layout
  title="Mission Log - Jarvis Hub"
  description="Selected client collaborations, experiments, and systems work."
  seo={{
    type: "website",
    image: {
      src: "/favicon.svg",
      alt: "Jarvis Hub logomark",
    },
    structuredData: projectsStructuredData,
  }}
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-16">
    <header
      class="relative pt-24 pb-12 md:pt-32 md:pb-16 px-4 sm:px-6 lg:px-8 border-b border-black/5 bg-black/[0.02] overflow-hidden rounded-3xl mt-6"
    >
      <!-- Background Grid -->
      <div
        class="absolute inset-0 bg-grid-pattern opacity-[0.03] pointer-events-none"
      >
      </div>

      <div class="max-w-6xl mx-auto relative z-10">
        <div
          class="flex flex-col md:flex-row md:items-end justify-between gap-8 animate-in-fade"
        >
          <div class="space-y-6 max-w-2xl">
            <div
              class="inline-flex items-center gap-2 px-2 py-1 bg-black/5 rounded text-xs font-pixel text-secondary uppercase tracking-wider"
            >
              <span class="w-2 h-2 rounded-full bg-accent-violet animate-pulse"
              ></span>
              Mission Control
            </div>

            <h1
              class="text-5xl md:text-7xl font-display font-medium tracking-tight leading-[0.9]"
            >
              Selected <br />
              <span
                class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-primary/60"
                >Works & Labs.</span
              >
            </h1>

            <p
              class="text-lg md:text-xl text-secondary leading-relaxed max-w-lg"
            >
              A curated archive of client collaborations, experiments, and
              system engineering.
            </p>

            <!-- Filter Controls -->
            <div class="flex flex-wrap gap-2 pt-4" id="project-filters">
              <button
                class="filter-btn px-3 py-1.5 text-xs font-pixel uppercase tracking-wider rounded border border-black/10 bg-white hover:bg-black/5 transition-colors active-filter"
                data-filter="all"
              >
                All Systems
              </button>
              <button
                class="filter-btn px-3 py-1.5 text-xs font-pixel uppercase tracking-wider rounded border border-black/10 bg-white hover:bg-black/5 transition-colors opacity-60 hover:opacity-100"
                data-filter="featured"
              >
                Featured
              </button>
              <button
                class="filter-btn px-3 py-1.5 text-xs font-pixel uppercase tracking-wider rounded border border-black/10 bg-white hover:bg-black/5 transition-colors opacity-60 hover:opacity-100"
                data-filter="lab"
              >
                Lab Experiments
              </button>
            </div>
          </div>

          <!-- Stats / Meta -->
          <div
            class="flex gap-8 md:text-right font-pixel text-sm text-secondary/80 border-t md:border-t-0 md:border-l border-black/10 pt-4 md:pt-0 md:pl-8"
          >
            <div class="flex flex-col">
              <span class="text-[10px] uppercase tracking-widest opacity-50"
                >Deployed</span
              >
              <span class="text-xl text-primary font-display"
                >{projects.length}</span
              >
            </div>
            <div class="flex flex-col">
              <span class="text-[10px] uppercase tracking-widest opacity-50"
                >In Progress</span
              >
              <span class="text-xl text-primary font-display"
                >{
                  projects.filter((p) => p.data.status === "in-progress").length
                }</span
              >
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="projects-grid" class="space-y-16 min-h-[50vh]">
      {
        featured.length > 0 && (
          <section
            class="space-y-8 project-section"
            data-section="featured"
            aria-label="Featured projects"
          >
            <h2 class="text-2xl font-display flex items-center gap-2">
              <span class="w-1.5 h-1.5 bg-black rounded-full" />
              Featured Systems
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              {featured.map((project) => (
                <div class="project-item" data-featured="true">
                  <ProjectCard project={project} />
                </div>
              ))}
            </div>
          </section>
        )
      }

      {
        rest.length > 0 && (
          <section
            class="space-y-8 project-section"
            data-section="rest"
            aria-label="More work"
          >
            <h2 class="text-2xl font-display flex items-center gap-2">
              <span class="w-1.5 h-1.5 bg-black/30 rounded-full" />
              Archive & Experiments
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {rest.map((project) => (
                <div class="project-item" data-featured="false">
                  <ProjectCard project={project} />
                </div>
              ))}
            </div>
          </section>
        )
      }
    </div>
  </div>

  <script>
    function initProjectFilters() {
      const buttons = document.querySelectorAll(".filter-btn");
      const sections = document.querySelectorAll(".project-section");
      const items = document.querySelectorAll(".project-item");
      const titles = document.querySelectorAll("h2");

      if (!buttons.length) return;

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const filter = btn.getAttribute("data-filter");

          // Update button states
          buttons.forEach((b) => {
            b.classList.remove(
              "active-filter",
              "opacity-100",
              "bg-black",
              "text-white"
            );
            b.classList.add("bg-white", "text-secondary", "opacity-60");
            if (b === btn) {
              b.classList.add(
                "active-filter",
                "opacity-100",
                "bg-black",
                "text-white"
              );
              b.classList.remove("bg-white", "text-secondary", "opacity-60");
            }
          });

          // Filter logic
          if (filter === "all") {
            sections.forEach((s) => s.classList.remove("hidden"));
            items.forEach((item) => item.classList.remove("hidden"));
            titles.forEach((t) => t.classList.remove("hidden"));
          } else if (filter === "featured") {
            // Hide "More work" section completely
            sections.forEach((s) => {
              if (s.getAttribute("data-section") === "rest")
                s.classList.add("hidden");
              else s.classList.remove("hidden");
            });
          } else if (filter === "lab") {
            // Hide "Featured" section, show "More work"
            sections.forEach((s) => {
              if (s.getAttribute("data-section") === "featured")
                s.classList.add("hidden");
              else s.classList.remove("hidden");
            });
          }
        });
      });
    }

    // Init on load and after transitions
    initProjectFilters();
    document.addEventListener("astro:page-load", initProjectFilters);
  </script>

  <style>
    .active-filter {
      @apply bg-black text-white border-black opacity-100;
    }
  </style>
</Layout>
