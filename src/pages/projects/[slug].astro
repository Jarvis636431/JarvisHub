---
import Layout from "@layouts/Layout.astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects", ({ data }) =>
    import.meta.env.DEV ? true : data.status !== "archived"
  );
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props as { project: CollectionEntry<"projects"> };
const { Content } = await project.render();

const publishDate = new Date(project.data.publishDate).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
});

const updatedDate = project.data.updatedDate
  ? new Date(project.data.updatedDate).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
    })
  : undefined;

const publishDateIso = new Date(project.data.publishDate).toISOString();
const updatedDateIso = project.data.updatedDate
  ? new Date(project.data.updatedDate).toISOString()
  : undefined;

const siteOrigin = Astro.site?.origin ?? Astro.url.origin ?? "https://jarvishub.com";
const canonicalUrl = new URL(Astro.url.pathname, siteOrigin).toString();
const coverImageUrl = project.data.coverImage
  ? new URL(project.data.coverImage, siteOrigin).toString()
  : undefined;

const projectStructuredData: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  name: project.data.title,
  description: project.data.summary,
  url: canonicalUrl,
  mainEntityOfPage: canonicalUrl,
  datePublished: publishDateIso,
  dateModified: updatedDateIso ?? publishDateIso,
  inLanguage: "en-US",
  creator: {
    "@type": "Person",
    name: "Jarvis Hub",
  },
};

if (project.data.roles.length > 0) {
  projectStructuredData.about = project.data.roles.join(", ");
}

if (project.data.stack.length > 0) {
  projectStructuredData.keywords = project.data.stack.join(", ");
}

if (coverImageUrl) {
  projectStructuredData.image = [coverImageUrl];
}

if (project.data.externalUrl) {
  projectStructuredData.sameAs = [project.data.externalUrl];
}
---

<Layout
  title={`${project.data.title} - Jarvis Hub`}
  description={project.data.summary}
  seo={{
    canonical: canonicalUrl,
    type: "article",
    image: project.data.coverImage
      ? {
          src: project.data.coverImage,
          alt: project.data.title,
        }
      : undefined,
    publishedTime: publishDateIso,
    modifiedTime: updatedDateIso,
    tags: project.data.stack,
    structuredData: projectStructuredData,
  }}
>
  <article class="project">
    <header class="project__hero">
      <a class="project__breadcrumb" href="/projects">← Back to all projects</a>
      <div class="project__hero-grid">
        <div class="project__hero-left">
          <div class="project__meta">
            <span class={`status status--${project.data.status}`}>{project.data.status}</span>
            <span>{publishDate}</span>
            {updatedDate && (
              <>
                <span>•</span>
                <span>Updated {updatedDate}</span>
              </>
            )}
          </div>
          <h1>{project.data.title}</h1>
          <p class="project__summary">{project.data.summary}</p>
          <div class="project__details">
            {project.data.roles.length > 0 && (
              <div>
                <h2>Roles</h2>
                <p>{project.data.roles.join(", ")}</p>
              </div>
            )}
            {project.data.stack.length > 0 && (
              <div>
                <h2>Stack</h2>
                <p>{project.data.stack.join(" · ")}</p>
              </div>
            )}
            {project.data.externalUrl && (
              <div>
                <h2>Live</h2>
                <a class="project__link" href={project.data.externalUrl} target="_blank" rel="noreferrer">
                  Visit project ↗
                </a>
              </div>
            )}
          </div>
        </div>
        <div class="project__hero-right">
          {project.data.coverImage && (
            <img
              class="project__cover"
              src={project.data.coverImage}
              alt={project.data.title}
              loading="lazy"
            />
          )}
        </div>
      </div>
    </header>

    <section class="project__content">
      <div class="project__content-grid">
        <aside class="project__toc">
          <div class="project__toc-title">目录</div>
          <nav id="project-toc" class="project__toc-list"></nav>
        </aside>
        <div class="project__article" id="project-article">
          <div class="prose-pixel">
            <Content />
          </div>
        </div>
      </div>
    </section>
  </article>
</Layout>

<style>
  .project {
    display: flex;
    flex-direction: column;
    gap: 40px;
  }

  .project__hero {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .project__hero-grid {
    display: grid;
    grid-template-columns: 1.6fr 0.9fr;
    gap: 24px;
    align-items: start;
  }

  .project__hero-left,
  .project__hero-right {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .project__hero-right {
    align-items: flex-end;
  }

  .project__breadcrumb {
    color: rgba(148, 163, 184, 0.85);
    text-decoration: none;
    font-size: 0.95rem;
  }

  .project__breadcrumb:hover {
    color: #f8fafc;
  }

  .project__meta {
    display: flex;
    gap: 10px;
    align-items: center;
    color: rgba(148, 163, 184, 0.85);
    font-size: 0.9rem;
  }

  .project__hero h1 {
    margin: 0;
    font-size: clamp(2.4rem, 4vw, 3.2rem);
  }

  .project__summary {
    margin: 0;
    font-size: 1.1rem;
    line-height: 1.7;
    color: rgba(203, 213, 225, 0.9);
    max-width: 720px;
  }

  .project__details {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  .project__details h2 {
    margin: 0 0 6px;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.7);
  }

  .project__details p,
  .project__link {
    margin: 0;
    color: rgba(203, 213, 225, 0.9);
    text-decoration: none;
  }

  .project__link:hover {
    color: #f8fafc;
  }

  .project__cover {
    width: 100%;
    height: auto;
    border-radius: 24px;
    border: 1px solid rgba(148, 163, 184, 0.18);
    background: rgba(11, 16, 32, 0.6);
    object-fit: cover;
    max-width: 420px;
  }

  .project__content {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .project__content-grid {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 24px;
    align-items: start;
  }

  .project__toc {
    position: sticky;
    top: 120px;
    align-self: start;
    border: 1px solid rgba(148, 163, 184, 0.18);
    background: rgba(11, 16, 32, 0.6);
    border-radius: 16px;
    padding: 12px;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.06), 0 10px 30px rgba(34,211,238,0.12);
  }

  .project__toc-title {
    font-size: 0.9rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(148, 163, 184, 0.7);
    margin: 6px 8px 10px;
    padding-bottom: 8px;
    border-bottom: 1px dashed rgba(148,163,184,0.18);
  }

  .project__toc-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 60vh;
    overflow: auto;
  }

  .project__toc-item {
    display: block;
    padding: 8px 12px;
    border-left: 2px solid transparent;
    color: rgba(203, 213, 225, 0.9);
    text-decoration: none;
    font-size: 0.95rem;
    border-radius: 8px;
    transition: all 0.15s ease;
  }

  .project__toc-item::before {
    content: ">";
    margin-right: 8px;
    color: #a78bfa;
  }

  .project__toc-item.active {
    border-left-color: #22d3ee;
    color: #22d3ee;
    background: rgba(34, 211, 238, 0.06);
  }

  .project__toc-sub {
    padding-left: 18px;
    font-size: 0.88rem;
    color: rgba(148, 163, 184, 0.85);
  }

  .project__article {
    min-width: 0;
  }

  .project__article h2,
  .project__article h3 {
    scroll-margin-top: 120px;
  }

  .status {
    text-transform: capitalize;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.18);
  }

  .status--launched {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.35);
    color: rgba(134, 239, 172, 0.95);
  }

  .status--in-progress {
    background: rgba(250, 204, 21, 0.1);
    border-color: rgba(250, 204, 21, 0.35);
    color: rgba(253, 224, 71, 0.95);
  }

  .status--archived {
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.35);
    color: rgba(148, 163, 184, 0.95);
  }

  @media (max-width: 720px) {
    .project__hero-grid {
      grid-template-columns: 1fr;
    }

    .project__hero-right {
      align-items: stretch;
    }

    .project__cover {
      max-width: 100%;
    }

    .project__details {
      grid-template-columns: 1fr;
    }

    .project__content-grid {
      grid-template-columns: 1fr;
    }

    .project__toc {
      position: static;
      top: auto;
    }
  }
</style>

<script>
  const article = document.getElementById("project-article");
  const toc = document.getElementById("project-toc");
  if (article && toc) {
    const headings = Array.from(article.querySelectorAll("h2, h3"));
    const slugify = (s) => s.toLowerCase().trim().replace(/[^a-z0-9\u4e00-\u9fa5]+/g, "-").replace(/^-+|-+$/g, "");
    const items = [];
    headings.forEach((h) => {
      const text = h.textContent || "";
      const id = h.id || slugify(text);
      if (!h.id) h.id = id;
      items.push({ id, depth: h.tagName === "H2" ? 2 : 3, text });
    });
    const html = items
      .map((i) => `<a href="#${i.id}" class="project__toc-item ${i.depth === 3 ? "project__toc-sub" : ""}" data-id="${i.id}">${i.text}</a>`)
      .join("");
    toc.innerHTML = html;
    const links = Array.from(toc.querySelectorAll(".project__toc-item"));
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.id;
          const link = toc.querySelector(`.project__toc-item[data-id="${id}"]`);
          if (link) {
            if (entry.isIntersecting) {
              links.forEach((l) => l.classList.remove("active"));
              link.classList.add("active");
            }
          }
        });
      },
      { rootMargin: "0px 0px -60% 0px", threshold: 0.1 }
    );
    headings.forEach((h) => observer.observe(h));
  }
</script>
